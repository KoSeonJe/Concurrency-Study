# 스토리지 엔진 수준의 락 종류

- MySQL에서 사용되는 락의 종류
    - 스토리지 엔진 레벨
      → 테이블의 데이터를 다루기 위한 락
    - MySQL 엔진 레벨
      → 테이블이나 데이터베이스 등과 같은 부분을 위한 락


### 스토리지 엔진 수준의 락의 종류

1. 레코드 락
2. 갭 락
3. 넥스트 키 락
4. 자동 증가 락

### 1. 레코드 락(Record Lock)

- 테이블 레코드 자체를 잠그는 락
- MySQL에서 레코드 락은 테이블의 레코드가아닌 인덱스의 레코드를 잠근다는 점에서 중요한 차이가 있다.

ex)
member 테이블에 성(last_name)이 J로 시작하는 구성원 300명

성(last_name)이 J로 시작하며 이름(first_name)이 MangKyu인 사원 1명

```sql
SELECT COUNT(*) FROM member WHERE last_name LIKE 'J%';

SELECT COUNT(*) FROM member WHERE last_name LIKE 'J%' AND first_name = 'MangKyu';
```

성(last_name)에만 인덱스가 걸려있는 경우, 성이 J로 시작하며 이름이 MangKyu인 구성원의 등록일을 변경하는 UPDATE 쿼리 실행

```sql
UPDATE member SET register_date = NOW() WHERE last_name LIKE 'J%' AND first_name = 'MangKyu';
```

→ 해당 1건을 업데이트하기 위해 300건의 인덱스 레코드에 잠금이 걸린다. 왜냐하면 MySQL은 테이블 레코드가 아닌 인덱스에 잠금을 걸기 때문이다. 인덱스는 성(last_name)으로만 구성되어 있기 때문에, 해당 레코드를 갱신하기 위해서는 인덱스를 통해 검색되는 모든 레코드에 잠금을 걸게 된다.

→ 동시성이 상당히 떨어지게 되므로 인덱스의 설계가 매우 중요하다.

### 2. 갭 락

- 레코드가 아닌 레코드와 레코드 사이의 간격을 잠금
- 레코드의 생성, 수정 및 삭제를 제어

ex)

num테이블에 2, 3이라는 인덱스 레코드가 존재할 때, 테이블에서 1이상 5이하의 조건으로 데이터를 검색한다면, 현존하는 2와 3에 걸리는 락이 레코드 락이다.

아직 현존하지 않은 1과 4, 5가 추가될 수 있는 공간에 걸리는 락이 바로 갭 락이다.

<img width="501" alt="스크린샷 2024-03-25 오후 2 37 08" src="https://github.com/COW-edu/COW-Spring-3/assets/127813439/fe68454a-c6d2-4162-bdd4-53a1ffbd183c">

→ 아직 존재하지 않지만, 지정된 범위에 해당하는 인덱스 테이블 공간을 대상으로 거는 잠금이다.

Pantom Read(유령 읽기)를 방지하는데 도움이 된다.

### 3. 넥스트 키 락

- 레코드 락과 갭락을 합친 잠금이다.
- 앞서 살펴본 갭 락은 단독으로 사용되기 보다 넥스트 키 락의 일부로 함께 사용된다.

### 4. 자동 증가 락

- MySQL에서는 자동 증가하는 숫자값을 채번하기 위해 AUTO_INCREMENT라는 컬럼 속성을 제공하며, 이는 주로 대체키에 사용된다.
- 여러 레코드가 동시에 INSERT되더라도 중복되지 않고 순차적으로 증가하는 일련번호를 제공하기 위해 내부적으로 테이블 수준의 잠금인  자동 증가 락을 사용한다.

[Reference]
- https://mangkyu.tistory.com/298